<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Senior Citizen Dues Tracker</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Poppins', 'sans-serif'] },
          colors: {
            mint: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#10b981', 600: '#059669', 700: '#047857' },
            gold: { 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706' }
          }
        }
      }
    }
  </script>

  <style>
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-mint-50 font-sans h-screen flex overflow-hidden">

  <!-- SIDEBAR -->
  <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white shadow-2xl z-30 transform -translate-x-full lg:translate-x-0 lg:static flex flex-col border-r border-mint-100">
    <div class="h-16 flex items-center justify-center border-b border-mint-100 bg-mint-500 text-white">
      <div class="flex items-center gap-2 font-bold text-xl"><i data-lucide="users" class="w-6 h-6"></i> SeniorTracker</div>
    </div>
    <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
      <button id="nav-input" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-all text-mint-700 bg-mint-100 shadow-sm ring-1 ring-mint-200">
        <i data-lucide="pen-tool" class="w-5 h-5"></i> Data Entry
      </button>
      <button id="nav-summary" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-all text-slate-500 hover:bg-slate-50 hover:text-mint-600">
        <i data-lucide="file-bar-chart" class="w-5 h-5"></i> Summary List
      </button>
    </nav>
    <div class="p-4 border-t border-mint-100 text-xs text-center text-slate-400">&copy; 2026 Community App</div>
  </aside>

  <!-- MAIN -->
  <div class="flex-1 flex flex-col h-full w-full relative">

    <!-- HEADER -->
    <header class="h-16 bg-white border-b border-mint-100 flex items-center justify-between px-4 lg:hidden">
      <button id="menu-btn" class="p-2 text-mint-700 hover:bg-mint-50 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button>
      <span class="font-bold text-lg text-mint-700">Senior Dues</span>
      <div class="w-10"></div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 lg:p-8 scroll-smooth relative">

      <!-- LOADING -->
      <div id="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-mint-50 z-50 text-mint-600">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-current mb-4"></div>
        <p class="animate-pulse font-medium">Loading Database...</p>
      </div>

      <!-- INPUT FORM -->
      <section id="view-input" class="max-w-2xl mx-auto fade-in">
        <div class="bg-white rounded-2xl shadow-sm border border-mint-100 overflow-hidden">
          <div class="bg-mint-500 p-6 text-white flex justify-between items-center">
            <div>
              <h2 id="form-title" class="text-xl font-bold flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i> New Entry</h2>
              <p class="text-mint-100 text-sm mt-1">Record monthly contributions</p>
            </div>
            <button id="cancel-edit" class="hidden text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full text-white transition">Cancel Edit</button>
          </div>
          <div class="p-6 space-y-6">
            <input type="hidden" id="doc-id">

            <!-- VERTICAL FORM -->
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Purok No.</label>
                <input id="purok" type="number" placeholder="e.g. 1" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-mint-500 focus:ring-2 focus:ring-mint-200 outline-none transition-all bg-slate-50 focus:bg-white">
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Senior Name</label>
                <input id="name" type="text" placeholder="Last Name, First Name" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-mint-500 focus:ring-2 focus:ring-mint-200 outline-none transition-all bg-slate-50 focus:bg-white">
              </div>
              <div class="bg-gold-500/10 p-5 rounded-xl border border-gold-500/20">
                <h3 class="text-gold-600 font-bold text-sm uppercase tracking-wider mb-4 flex items-center gap-2">
                  <i data-lucide="coins" class="w-4 h-4"></i> Contributions (PHP)
                </h3>
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">2023</label>
                    <input id="y2023" type="number" placeholder="0" class="w-full px-3 py-2 rounded-lg border border-gold-500/30 focus:border-gold-500 focus:ring-2 focus:ring-gold-500/20 outline-none text-right font-mono">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">2024</label>
                    <input id="y2024" type="number" placeholder="0" class="w-full px-3 py-2 rounded-lg border border-gold-500/30 focus:border-gold-500 focus:ring-2 focus:ring-gold-500/20 outline-none text-right font-mono">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">2025</label>
                    <input id="y2025" type="number" placeholder="0" class="w-full px-3 py-2 rounded-lg border border-gold-500/30 focus:border-gold-500 focus:ring-2 focus:ring-gold-500/20 outline-none text-right font-mono">
                  </div>
                </div>
              </div>
              <button id="save-btn" class="w-full bg-gold-500 hover:bg-gold-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-gold-500/30 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                <i data-lucide="save" class="w-5 h-5"></i> <span>Save Record</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- SUMMARY TABLE -->
      <section id="view-summary" class="hidden fade-in h-full flex flex-col">
        <div class="flex flex-col md:flex-row gap-4 mb-6 items-center justify-between">
          <h2 class="text-2xl font-bold text-mint-700">Records</h2>
          <div class="flex gap-2 w-full md:w-auto">
            <div class="relative flex-1 md:w-64">
              <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
              <input id="search-input" type="text" placeholder="Search name..." class="w-full pl-9 pr-4 py-2 rounded-lg border border-slate-200 focus:border-mint-500 focus:ring-2 focus:ring-mint-200 outline-none text-sm">
            </div>
            <button onclick="window.print()" class="bg-white text-slate-600 border border-slate-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-50 flex items-center gap-2">
              <i data-lucide="printer" class="w-4 h-4"></i> <span class="hidden sm:inline">Print</span>
            </button>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-mint-100 overflow-hidden flex-1">
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm min-w-max">
              <thead class="bg-mint-50 text-mint-800 border-b border-mint-100">
                <tr>
                  <th class="p-4 font-semibold">Purok</th>
                  <th class="p-4 font-semibold">Name</th>
                  <th class="p-4 text-right">2023</th>
                  <th class="p-4 text-right">2024</th>
                  <th class="p-4 text-right">2025</th>
                  <th class="p-4 text-right font-bold text-gold-600">Total</th>
                  <th class="p-4 text-center no-print">Edit</th>
                </tr>
              </thead>
              <tbody id="table-body" class="divide-y divide-slate-100"></tbody>
            </table>
          </div>
          <div id="empty-state" class="hidden p-8 text-center text-slate-400">
            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
            <p>No records found.</p>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- FIREBASE & JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAL3lrszwjehY8gANXjyMyMVx4-X9Xsc_E",
      authDomain: "senior-citizen-dues-tracker.firebaseapp.com",
      projectId: "senior-citizen-dues-tracker",
      storageBucket: "senior-citizen-dues-tracker.firebasestorage.app",
      messagingSenderId: "276183327912",
      appId: "1:276183327912:web:786cfbf3dcfc1aea45ce9d",
      measurementId: "G-KGVWPFQ6V7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(() => console.warn('Persistence failed'));

    let uid, cachedData = [];
    const loadingEl = document.getElementById('loading');

    const navInput = document.getElementById('nav-input');
    const navSummary = document.getElementById('nav-summary');
    const viewInput = document.getElementById('view-input');
    const viewSummary = document.getElementById('view-summary');

    const formTitle = document.getElementById('form-title');
    const docIdField = document.getElementById('doc-id');
    const cancelEditBtn = document.getElementById('cancel-edit');
    const saveBtn = document.getElementById('save-btn');
    const saveBtnText = saveBtn.querySelector('span');

    const inputPurok = document.getElementById('purok');
    const inputName = document.getElementById('name');
    const inputY23 = document.getElementById('y2023');
    const inputY24 = document.getElementById('y2024');
    const inputY25 = document.getElementById('y2025');

    signInAnonymously(auth);
    onAuthStateChanged(auth, user => {
      if (!user) return;
      uid = user.uid;
      loadingEl.classList.add('hidden');
      lucide.createIcons();
      subscribeTable(); // Start real-time updates
    });

    function getCollection() {
      return collection(db, 'artifacts', 'senior-citizen-dues-tracker', 'public', 'data', 'senior_dues');
    }

    function switchTab(tab) {
      if (tab === 'input') {
        viewInput.classList.remove('hidden'); viewSummary.classList.add('hidden');
        navInput.className = "w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-all text-mint-700 bg-mint-100 shadow-sm ring-1 ring-mint-200";
        navSummary.className = "w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-all text-slate-500 hover:bg-slate-50 hover:text-mint-600";
      } else {
        viewInput.classList.add('hidden'); viewSummary.classList.remove('hidden');
        navSummary.className = "w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-all text-mint-700 bg-mint-100 shadow-sm ring-1 ring-mint-200";
        navInput.className = "w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-all text-slate-500 hover:bg-slate-50 hover:text-mint-600";
      }
    }

    navInput.onclick = () => switchTab('input');
    navSummary.onclick = () => switchTab('summary');

    saveBtn.onclick = async () => {
      const docId = docIdField.value;
      const data = {
        purok: inputPurok.value,
        name: inputName.value,
        y2023: Number(inputY23.value) || 0,
        y2024: Number(inputY24.value) || 0,
        y2025: Number(inputY25.value) || 0
      };
      if (!data.purok || !data.name) return alert('Name and Purok are required.');
      saveBtn.disabled = true; saveBtnText.innerText = "Processing...";
      try {
        if (docId) {
          const docRef = doc(db, 'artifacts', 'senior-citizen-dues-tracker', 'public', 'data', 'senior_dues', docId);
          await updateDoc(docRef, data);
          alert('Entry Updated Successfully'); resetForm(); switchTab('summary');
        } else {
          await addDoc(getCollection(), data);
          alert('Entry Saved Successfully'); resetForm();
        }
      } catch(e) { console.error(e); alert('Error saving data'); }
      saveBtn.disabled = false; saveBtnText.innerText = docId ? "Update Record" : "Save Record";
    };

    function subscribeTable() {
      const tbody = document.getElementById('table-body');
      const emptyState = document.getElementById('empty-state');
      onSnapshot(getCollection(), snapshot => {
        cachedData = [];
        snapshot.forEach(doc => cachedData.push({ id: doc.id, ...doc.data() }));
        cachedData.sort((a,b) => a.name.localeCompare(b.name));

        const term = document.getElementById('search-input').value.toLowerCase().trim();
        const filtered = cachedData.filter(d => 
          d.name.toLowerCase().includes(term) || String(d.purok).includes(term)
        );
        renderTable(filtered);
      });
    }

    function renderTable(data) {
      const tbody = document.getElementById('table-body');
      const emptyState = document.getElementById('empty-state');
      tbody.innerHTML = '';
      if (data.length === 0) { emptyState.classList.remove('hidden'); return; }
      emptyState.classList.add('hidden');
      data.forEach(r => {
        const total = (r.y2023||0)+(r.y2024||0)+(r.y2025||0);
        const row = document.createElement('tr');
        row.className = 'hover:bg-mint-50 transition-all';
        row.innerHTML = `
          <td class="p-4">${r.purok}</td>
          <td class="p-4">${r.name}</td>
          <td class="p-4 text-right">${r.y2023||0}</td>
          <td class="p-4 text-right">${r.y2024||0}</td>
          <td class="p-4 text-right">${r.y2025||0}</td>
          <td class="p-4 text-right font-bold text-gold-600">${total}</td>
          <td class="p-4 text-center no-print">
            <button onclick="editRecord('${r.id}')" class="text-mint-600 hover:text-mint-700"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
          </td>`;
        tbody.appendChild(row);
      });
      lucide.createIcons();
    }

    function editRecord(id) {
      const record = cachedData.find(r => r.id === id);
      if (!record) return;
      docIdField.value = record.id;
      inputPurok.value = record.purok;
      inputName.value = record.name;
      inputY23.value = record.y2023||0;
      inputY24.value = record.y2024||0;
      inputY25.value = record.y2025||0;
      formTitle.innerHTML = '<i data-lucide="edit-3" class="w-5 h-5"></i> Edit Entry';
      saveBtnText.innerText = "Update Record";
      cancelEditBtn.classList.remove('hidden');
      switchTab('input');
      lucide.createIcons();
    }

    cancelEditBtn.onclick = resetForm;
    function resetForm() {
      docIdField.value = '';
      inputPurok.value = '';
      inputName.value = '';
      inputY23.value = inputY24.value = inputY25.value = '';
      formTitle.innerHTML = '<i data-lucide="plus-circle" class="w-5 h-5"></i> New Entry';
      saveBtnText.innerText = "Save Record";
      cancelEditBtn.classList.add('hidden');
    }

    document.getElementById('search-input').addEventListener('input', () => {
      const term = document.getElementById('search-input').value.toLowerCase().trim();
      const filtered = cachedData.filter(d => d.name.toLowerCase().includes(term) || String(d.purok).includes(term));
      renderTable(filtered);
    });

  </script>
</body>
</html>
